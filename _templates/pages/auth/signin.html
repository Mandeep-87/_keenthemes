{% extends layout %} 
{% load i18n %} 
{% block title %} 
{% translate "Login" %}
{%endblock %}
{% block content %}

<!--begin::Form-->

<style>
    span.validation-message {
    color: red;
    font-size: 12px;
    float: left;
    width: 100%;
    margin-top: 5px;
}  
</style>


<form class="form w-100" id="loginForm" method="POST">
    {% csrf_token %}

  <!--begin::Heading-->
  <div class="text-center mb-11">
    <!--begin::Title-->
    <h1 class="text-gray-900 fw-bolder mb-3">Sign In</h1>
  </div>

  <!--begin::Input group--->
  <div class="fv-row mb-8">
    <!--begin::username-->
    <input
      type="text"
      placeholder="Username"
      name="username"
      autocomplete="off"
      class="form-control bg-transparent"
    />
    <span class="validation-message" id="usernameValidation"></span>
    <!--end::username-->
  </div>

  <!--end::Input group--->
  <div class="fv-row mb-3">
    <!--begin::Password-->
    <input
      type="password"
      placeholder="Password"
      name="password"
      autocomplete="off"
      class="form-control bg-transparent"
    />
    <span class="validation-message" id="passwordValidation"></span>
    <!--end::Password-->
  </div>
  <!--end::Input group--->

  <!--begin::Wrapper-->
  <div class="d-flex flex-stack flex-wrap gap-3 fs-base fw-semibold mb-8">
    <div></div>

    <!--begin::Link-->
    <a href="{% url 'auth:reset-password' %}" class="link-primary">
      Forgot Password ?
    </a>
    <!--end::Link-->
  </div>
  <!--end::Wrapper-->

  <!--begin::Submit button-->
  <div class="d-grid mb-10">
    <button
      type="button"
      id="submitBtn"
      class="fw-bold btn btn-lg btn-primary w-100 mb-5"
    >
      <span class="indicator-label">Continue</span>
      <span class="indicator-progress"
        >Please wait...
        <span class="spinner-border spinner-border-sm align-middle ms-2"></span
      ></span>
    </button>
  </div>
  <!--end::Submit button-->

  <!--begin::Sign up-->
  <div class="text-gray-500 text-center fw-semibold fs-6">
    Not a Member yet?

    <a href="{% url 'auth:signup' %}" class="link-primary"> Sign up </a>
  </div>
  <!--end::Sign up-->
</form>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
  $(document).ready(function () {
    $("#submitBtn").click(function () {
      // Clear previous validation messages
      $(".validation-message").text("");

      // Perform client-side validation
      var username = $("input[name='username']").val();
      var password = $("input[name='password']").val();
      var errors = [];

      if (!username) {
        errors.push("Username is required");
        $("#usernameValidation").text("Username is required");
      }

      if (!password) {
        errors.push("Password is required");
        $("#passwordValidation").text("Password is required");
      }

      if (!password.length > 7) {
        errors.push("Password should  be more than 8 characters");
        $("#passwordValidation").text(
          "Password should  be more than 8 characters"
        );
      }

      // Stop form submission if there are errors
      if (errors.length > 0) {
        Swal.fire({
          icon: "error",
          title:
            "Sorry,looks like there are some errors detected, please try again!",
          showConfirmButton: true,
          confirmButtonText: "OK,got it!",
        });
        return;
      }

      // Get form data
      var formData = $("#loginForm").serialize();
      var csrfToken = $("[name=csrfmiddlewaretoken]").val();

      // Ajax request
      $.ajax({
        type: "POST",
        url: "{% url 'auth:signin' %}", // Replace with your server endpoint
        data: formData,
        headers: {
          "X-CSRFToken": csrfToken,
        },
        success: function (response) {
          console.log(response);
          // Check if the API response is true
          if (response == "Login successful") {
            // Show a SweetAlert success popup
            Swal.fire({
              icon: "success",
              title: "Login Successful!",
              showConfirmButton: false,
              timer: 1500,
            });

            // Optionally, you can redirect the user or perform other actions
            setTimeout(() => {
              window.location.href = "/"; // Example: Redirect to the dashboard
            }, 1500);
          }
        },
        error: function (error) {
          Swal.fire({
            icon: "error",
            title: "Invalid username or password. Please try again.",
            showConfirmButton: false,
            timer: 1500,
          });
        },
      });
    });

    // Clear validation messages on input
    $("input[name='username']").on("input", function () {
      $("#usernameValidation").text("");
    });

    $("input[name='password']").on("input", function () {
      $("#passwordValidation").text("");
    });
  });
</script>
<!--end::Form-->
.. {% endblock content %}
